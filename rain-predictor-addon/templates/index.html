<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rain Predictor</title>
    <style>
        body, html { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            background-color: #1c1c1c; 
            color: #e0e0e0; 
            font-family: Arial, sans-serif; 
            display: flex; 
            flex-direction: column; 
        }
        
        #rainviewer-map {
            width: 100%;
            height: 100%;
            border: none;
            flex-grow: 1;
            /* Try to hide any overlay elements */
            overflow: hidden;
        }
        
        /* Additional CSS to try to hide RainViewer UI elements */
        #rainviewer-map::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: transparent;
            pointer-events: none;
            z-index: 1000;
        }
        
        #data-panel { 
            background-color: #2a2a2a; 
            padding: 10px; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            border-top: 1px solid #444; 
            flex-shrink: 0; 
        }
        
        .data-item { 
            text-align: center; 
        }
        
        .data-value { 
            font-size: 1.5em; 
            font-weight: bold; 
        }
        
        .data-label { 
            font-size: 0.8em; 
            color: #aaa; 
        }
    </style>
</head>
<!-- Pass data from backend to frontend using data-* attributes -->
<body data-latitude="{{ latitude }}" data-longitude="{{ longitude }}" data-api-url="{{ api_url | safe }}">

    <!-- RainViewer iframe -->
    <iframe id="rainviewer-map" allowfullscreen></iframe>

    <div id="data-panel">
        <div class="data-item"><div class="data-value" id="time-to-rain">--</div><div class="data-label">TIME TO RAIN</div></div>
        <div class="data-item"><div class="data-value" id="distance">--</div><div class="data-label">DISTANCE</div></div>
        <div class="data-item"><div class="data-value" id="speed">--</div><div class="data-label">SPEED</div></div>
        <div class="data-item"><div class="data-value" id="direction">--</div><div class="data-label">DIRECTION</div></div>
        <div class="data-item"><div class="data-value" id="bearing">--</div><div class="data-label">BEARING</div></div>
    </div>

    <script>
        const latitude = parseFloat(document.body.dataset.latitude);
        const longitude = parseFloat(document.body.dataset.longitude);
        const apiUrl = document.body.dataset.apiUrl;

        // Correct RainViewer parameters based on actual documentation
        function updateRainViewerMap() {
            const mapFrame = document.getElementById('rainviewer-map');
            
            // Correct RainViewer URL parameters:
            // loc = latitude,longitude,zoom (location and zoom)
            // p = 1 (play animation)
            // t = 1 (show time controls) 
            // s = 1 (smooth animation)
            // c = 1 (color scheme)
            // o = 85 (opacity)
            // lm = 1 (light mode - try this instead of lm=0)
            // m = 1 (show marker)
            const rainviewerUrl = `https://www.rainviewer.com/map.html?loc=${latitude},${longitude},10&p=1&t=1&s=1&c=1&o=85&m=1&lm=1`;
            
            mapFrame.src = rainviewerUrl;
            console.log("RainViewer map URL set:", rainviewerUrl);
            
            // Auto-start animation after map loads
            mapFrame.onload = function() {
                console.log("Map loaded, attempting to start animation...");
                // Try to trigger play via postMessage if available
                try {
                    mapFrame.contentWindow.postMessage({action: 'play'}, '*');
                } catch(e) {
                    console.log("Could not send play message to map frame");
                }
            };
        }
        
        function updateDataDisplay(data) {
            let timeText = data.time_to_rain;
            if (timeText === '999') timeText = "No Rain";
            else if (timeText !== null && timeText !== '--') timeText = `${timeText} min`;
            else timeText = '--';
            document.getElementById('time-to-rain').innerText = timeText;

            document.getElementById('distance').innerText = data.distance !== null && data.distance !== '--' ? `${data.distance} km` : '--';
            document.getElementById('speed').innerText = data.speed !== null && data.speed !== '--' ? `${data.speed} kph` : '--';
            document.getElementById('direction').innerText = data.direction !== null && data.direction !== 'N/A' ? `${data.direction}°` : 'N/A';
            document.getElementById('bearing').innerText = data.bearing !== null && data.bearing !== 'N/A' ? `${data.bearing}°` : 'N/A';
        }

        async function fetchAndUpdateData() {
            try {
                const response = await fetch(apiUrl); 
                if (!response.ok) {
                    console.error(`API request failed with status: ${response.status}`);
                    return; 
                }
                const data = await response.json();
                updateDataDisplay(data);
            } catch (error) {
                console.error('Error fetching or parsing prediction data:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateRainViewerMap(); // Set the map URL on page load
            fetchAndUpdateData(); 
            setInterval(fetchAndUpdateData, 5000); // Update data panel every 5 seconds
        });
    </script>
</body>
</html>